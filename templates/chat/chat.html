{% extends 'base.html' %}
{% block title %}Chat - VoiceGenie{% endblock %}
{% block content %}
<script>
  window.PREFERRED_VOICE = '{{ preferred_voice|escapejs }}'
  window.DEFAULT_MODEL = '{{ default_model|escapejs }}'
  window.INITIAL_CHAT_ID = '{{ initial_chat_id|default:''|escapejs }}';
</script>

<div class="flex flex-col h-[calc(100vh-180px)] md:h-[calc(100vh-160px)]">
  <div class="flex flex-col md:flex-row flex-1 gap-4 min-h-0">
    <!-- Sidebar -->
    <aside class="w-full md:w-72 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg overflow-hidden flex flex-col shadow">
      <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold">Chats</h3>
        </div>
        <button id="newChatBtn" class="text-sm px-3 py-1 bg-primary text-white rounded hover:bg-primary-dark transition">New</button>
      </div>
      <div class="p-3 border-b dark:border-gray-700">
        <input id="chatSearch" class="w-full p-2 text-sm border rounded dark:bg-gray-900 dark:border-gray-700" placeholder="Search chats..." />
      </div>
      <div id="chatList" class="flex-1 overflow-y-auto"></div>
    </aside>

    <!-- Main chat area -->
    <section class="flex-1 flex flex-col bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow">
      <div class="p-3 border-b dark:border-gray-700 flex items-center gap-3 flex-wrap">
        <select id="modelSelect" class="p-2 text-sm border rounded dark:bg-gray-900 dark:border-gray-700">
          <option value="gpt-5.0">GPT-5.0</option>
          <option value="gpt-4o-mini">GPT-4o Mini</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        </select>
        <select id="voiceSelect" class="p-2 text-sm border rounded dark:bg-gray-900 dark:border-gray-700">
          <option value="">Default Voice</option>
        </select>
        <span id="chatTitle" class="font-semibold text-sm text-gray-700 dark:text-gray-200 truncate max-w-[120px]"></span>
      </div>

      <!-- Messages container with independent scrolling -->
      <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900/50 message-container">
        <!-- Messages will be inserted here -->
      </div>

      <!-- Input area -->
      <div class="p-3 border-t dark:border-gray-700">
        <form id="sendForm" class="flex flex-col gap-3">
          {% csrf_token %}
          <div class="flex gap-2">
            <textarea id="messageInput" class="flex-1 min-h-[48px] max-h-48 p-3 border rounded-lg resize-y dark:bg-gray-900 dark:border-gray-700 focus:ring-2 focus:ring-primary/50 focus:border-primary/50" placeholder="Type a message..." rows="1"></textarea>
            <button type="submit" class="self-end px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
              <span>Model:</span>
              <select id="modelSelectInline" class="p-1 text-xs border rounded dark:bg-gray-900 dark:border-gray-700">
                <option value="gpt-5.0">GPT-5.0</option>
                <option value="gpt-4o-mini">GPT-4o Mini</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
              </select>
              <span>Voice:</span>
              <select id="voiceSelectInline" class="p-1 text-xs border rounded dark:bg-gray-900 dark:border-gray-700">
                <option value="">Default</option>
              </select>
            </div>
            <button id="recordBtn" type="button" class="p-2 text-gray-500 hover:text-primary transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // DOM elements
  const chatListEl = document.getElementById('chatList');
  const messagesEl = document.getElementById('messages');
  const sendForm = document.getElementById('sendForm');
  const messageInput = document.getElementById('messageInput');
  const modelSelect = document.getElementById('modelSelect');
  const modelSelectInline = document.getElementById('modelSelectInline');
  const voiceSelect = document.getElementById('voiceSelect');
  const voiceSelectInline = document.getElementById('voiceSelectInline');
  const chatTitleEl = document.getElementById('chatTitle');
  const newChatBtn = document.getElementById('newChatBtn');
  const chatSearch = document.getElementById('chatSearch');
  const recordBtn = document.getElementById('recordBtn');

  // State variables
  let currentChatId = window.INITIAL_CHAT_ID || '';
  let currentModel = window.DEFAULT_MODEL || modelSelect.value;
  if (currentModel) {
    modelSelect.value = currentModel;
    modelSelectInline.value = currentModel;
  }

  // Auto-resize textarea
  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  // Utility functions
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function escapeHtml(str) {
    return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function renderMarkdownLite(text) {
    const safe = escapeHtml(text || '');
    const lines = safe.split(/\r?\n/);
    let html = '';
    let inList = false;
    
    for (const line of lines) {
      const trimmed = line.trim();
      const isBullet = /^(?:[-*•]|\d+\.)\s+/.test(trimmed);
      
      if (isBullet) {
        if (!inList) {
          html += '<ul class="list-disc pl-6 space-y-1">';
          inList = true;
        }
        html += `<li>${trimmed.replace(/^(?:[-*•]|\d+\.)\s+/, '')}</li>`;
      } else {
        if (inList) {
          html += '</ul>';
          inList = false;
        }
        if (trimmed === '') {
          html += '<br />';
        } else {
          html += `<p class="whitespace-pre-wrap">${trimmed}</p>`;
        }
      }
    }
    
    if (inList) html += '</ul>';
    return html;
  }

  // Message rendering
  function renderMessage(msg) {
    const wrap = document.createElement('div');
    const isUser = msg.role === 'user';
    
    wrap.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
    
    const bubble = document.createElement('div');
    bubble.className = `max-w-[90%] md:max-w-[80%] rounded-lg px-4 py-3 transition transform ${
      isUser 
        ? 'bg-primary text-white rounded-br-none' 
        : 'bg-white dark:bg-gray-700 border dark:border-gray-600 text-gray-900 dark:text-gray-100 rounded-bl-none'
    }`;
    bubble.innerHTML = renderMarkdownLite(msg.content);
    wrap.appendChild(bubble);

    if (!isUser) {
      const controls = document.createElement('div');
      controls.className = 'flex items-center gap-2 ml-2 mt-1';
      
      const listenBtn = document.createElement('button');
      listenBtn.className = 'p-2 text-gray-500 hover:text-primary dark:hover:text-primary transition rounded-full';
      listenBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>';
      listenBtn.title = 'Play audio';
      listenBtn.addEventListener('click', () => playTTS(msg.content));
      
      controls.appendChild(listenBtn);
      wrap.appendChild(controls);
    }

    return wrap;
  }

  // Chat loading functions
  async function loadChats() {
    try {
      const res = await fetch('/chat/list/');
      const data = await res.json();
      chatListEl.innerHTML = '';
      
      const query = chatSearch.value.trim().toLowerCase();
      data.chats
        .filter(chat => !query || chat.title.toLowerCase().includes(query))
        .forEach(chat => chatListEl.appendChild(renderChatItem(chat)));
    } catch (error) {
      console.error('Error loading chats:', error);
    }
  }

  function renderChatItem(chat) {
    const item = document.createElement('div');
    item.className = `p-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition cursor-pointer ${
      String(chat.id) === String(currentChatId) ? 'bg-gray-100 dark:bg-gray-700' : ''
    }`;
    
    const title = document.createElement('div');
    title.className = 'font-medium truncate';
    title.textContent = chat.title;
    
    const subtitle = document.createElement('div');
    subtitle.className = 'text-xs text-gray-500 dark:text-gray-400 truncate';
    subtitle.textContent = new Date(chat.updated_at).toLocaleString();
    
    item.appendChild(title);
    item.appendChild(subtitle);
    
    item.addEventListener('click', () => selectChat(chat.id));
    return item;
  }

  async function loadChat(chatId) {
    try {
      const res = await fetch(`/chat/api/chat/${chatId}/`);
      const data = await res.json();
      
      messagesEl.innerHTML = '';
      chatTitleEl.textContent = data.chat.title;
      
      const model = data.chat.model || modelSelect.value;
      modelSelect.value = model;
      modelSelectInline.value = model;
      currentModel = model;
      
      data.messages.forEach(msg => messagesEl.appendChild(renderMessage(msg)));
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } catch (error) {
      console.error('Error loading chat:', error);
    }
  }

  async function selectChat(chatId) {
    currentChatId = chatId;
    await loadChats();
    await loadChat(chatId);
  }

  async function ensureChatCreated(initialText) {
    if (currentChatId) return currentChatId;
    
    try {
      const form = new URLSearchParams();
      form.set('title', initialText || 'New Chat');
      form.set('model', modelSelect.value);
      
      const res = await fetch('/chat/create/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: form
      });
      
      const data = await res.json();
      currentChatId = data.chat_id;
      await loadChats();
      return currentChatId;
    } catch (error) {
      console.error('Error creating chat:', error);
      throw error;
    }
  }

  // Typing effect
  async function typeText(element, fullText, speed = 20) {
    return new Promise(resolve => {
      let i = 0;
      const timer = setInterval(() => {
        if (i >= fullText.length) {
          clearInterval(timer);
          resolve();
          return;
        }
        
        i++;
        element.innerHTML = renderMarkdownLite(fullText.slice(0, i));
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, speed);
    });
  }

  // Message sending
  async function sendMessage(e) {
    e.preventDefault();
    
    const text = messageInput.value.trim();
    if (!text) return;
    
    // Clear input immediately
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
    try {
      await ensureChatCreated(text);
      
      const form = new URLSearchParams();
      form.set('message', text);
      if (currentChatId) form.set('chat_id', currentChatId);
      form.set('model', modelSelect.value);
      
      // Optimistic render of user message
      messagesEl.appendChild(renderMessage({ role: 'user', content: text }));
      messagesEl.scrollTop = messagesEl.scrollHeight;
      
      // Create assistant message container
      const assistantWrap = document.createElement('div');
      assistantWrap.className = 'flex justify-start';
      
      const assistantBubble = document.createElement('div');
      assistantBubble.className = 'max-w-[90%] md:max-w-[80%] rounded-lg px-4 py-3 bg-white dark:bg-gray-700 border dark:border-gray-600 text-gray-900 dark:text-gray-100 rounded-bl-none';
      
      const assistantControls = document.createElement('div');
      assistantControls.className = 'flex items-center gap-2 ml-2 mt-1';
      
      const listenBtn = document.createElement('button');
      listenBtn.className = 'p-2 text-gray-500 hover:text-primary dark:hover:text-primary transition rounded-full';
      listenBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>';
      listenBtn.title = 'Play audio';
      
      assistantControls.appendChild(listenBtn);
      
      const row = document.createElement('div');
      row.className = 'flex items-start';
      row.appendChild(assistantBubble);
      row.appendChild(assistantControls);
      
      assistantWrap.appendChild(row);
      messagesEl.appendChild(assistantWrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      
      // Loading indicator
      assistantBubble.innerHTML = '<div class="flex space-x-2"><div class="w-2 h-2 rounded-full bg-gray-400 animate-pulse"></div><div class="w-2 h-2 rounded-full bg-gray-400 animate-pulse" style="animation-delay: 0.2s"></div><div class="w-2 h-2 rounded-full bg-gray-400 animate-pulse" style="animation-delay: 0.4s"></div></div>';
      
      // Send request
      const res = await fetch('/chat/send/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: form
      });
      
      if (!res.ok) {
        throw new Error(await res.text());
      }
      
      const data = await res.json();
      
      if (data.created) {
        currentChatId = data.chat_id;
        await loadChats();
      }
      
      // Type out the response
      const fullResponse = data.assistant?.content || '';
      listenBtn.addEventListener('click', () => playTTS(fullResponse));
      await typeText(assistantBubble, fullResponse);
      
      chatTitleEl.textContent = data.title;
    } catch (error) {
      console.error('Error sending message:', error);
      alert(error.message || 'Failed to send message');
    }
  }

  // Voice functions
  async function populateVoices() {
    try {
      const res = await fetch('/tts/voices/');
      const data = await res.json();
      const voices = data.voices || [];
      
      function populateSelect(select) {
        select.innerHTML = '';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Default Voice';
        select.appendChild(defaultOption);
        
        voices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.shortName;
          option.textContent = `${voice.shortName} (${voice.gender})`;
          select.appendChild(option);
        });
        
        if (window.PREFERRED_VOICE) {
          select.value = window.PREFERRED_VOICE;
        }
      }
      
      populateSelect(voiceSelect);
      populateSelect(voiceSelectInline);
    } catch (error) {
      console.error('Error loading voices:', error);
    }
  }

  async function playTTS(text) {
    const selectedVoice = voiceSelect.value || voiceSelectInline.value || '';
    
    try {
      const form = new URLSearchParams();
      form.set('text', text);
      if (selectedVoice) form.set('voice', selectedVoice);
      
      const res = await fetch('/tts/speak/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: form
      });
      
      if (!res.ok) {
        throw new Error(await res.text());
      }
      
      const blob = await res.blob();
      const audio = new Audio(URL.createObjectURL(blob));
      audio.play();
    } catch (error) {
      console.error('Error playing TTS:', error);
      alert('Failed to play audio');
    }
  }

  // Recording functionality
  let mediaRecorder;
  let recordedChunks = [];
  
  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recordedChunks = [];
      
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      
      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
          recordedChunks.push(e.data);
        }
      };
      
      mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
        messageInput.value = 'Processing recording...';
        
        try {
          // Here you would typically send to a speech-to-text API
          // For demo purposes, we'll just simulate it
          setTimeout(() => {
            messageInput.value = "This would be the transcribed text from the recording";
          }, 1500);
        } catch (error) {
          console.error('Error processing recording:', error);
          messageInput.value = '';
          alert('Failed to process recording');
        }
      };
      
      mediaRecorder.start();
      recordBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd" /></svg>';
    } catch (error) {
      console.error('Error starting recording:', error);
      alert('Microphone access denied or not available');
    }
  }
  
  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      recordBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" /></svg>';
    }
  }

  // Event listeners
  let isRecording = false;
  recordBtn.addEventListener('click', () => {
    if (!isRecording) {
      isRecording = true;
      startRecording();
    } else {
      isRecording = false;
      stopRecording();
    }
  });

  modelSelect.addEventListener('change', () => {
    currentModel = modelSelect.value;
    modelSelectInline.value = currentModel;
  });

  modelSelectInline.addEventListener('change', () => {
    currentModel = modelSelectInline.value;
    modelSelect.value = currentModel;
  });

  newChatBtn.addEventListener('click', async () => {
    currentChatId = '';
    chatTitleEl.textContent = '';
    messagesEl.innerHTML = '';
    messageInput.focus();
  });

  sendForm.addEventListener('submit', sendMessage);
  chatSearch.addEventListener('input', loadChats);

  // Initialize
  populateVoices();
  loadChats().then(() => {
    if (currentChatId) {
      loadChat(currentChatId);
    }
  });
</script>
{% endblock %}