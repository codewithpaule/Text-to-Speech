{% extends 'base.html' %}
{% block title %}Chat - VoiceGenie{% endblock %}
{% block content %}
<script>
  window.DEFAULT_MODEL = '{{ default_model|escapejs }}';
  window.INITIAL_CHAT_ID = '{{ initial_chat_id|default:''|escapejs }}';
</script>
<div class="container-fluid">
  <div class="row" style="height: calc(100vh - 64px);">
    <aside class="col-12 col-md-3 col-lg-2 border-end d-flex flex-column p-0">
      <div class="d-flex align-items-center justify-content-between px-3 py-2 border-bottom">
        <h6 class="mb-0">Chats</h6>
        <button id="newChatBtn" class="btn btn-sm btn-primary">New</button>
      </div>
      <div class="p-2 border-bottom">
        <input id="chatSearch" class="form-control form-control-sm" placeholder="Search chats..." />
      </div>
      <div id="chatList" class="flex-grow-1 overflow-auto"></div>
    </aside>

    <section class="col-12 col-md-9 col-lg-10 d-flex flex-column p-0">
      <div class="d-flex flex-wrap align-items-center gap-2 px-3 py-2 border-bottom">
        <select id="modelSelect" class="form-select form-select-sm" style="width:auto;">
          <option value="gpt-5.0">GPT-5.0</option>
          <option value="gpt-4o-mini">GPT-4o Mini</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        </select>
        <span class="fw-semibold small text-truncate" id="chatTitle"></span>
        <div class="ms-auto d-flex align-items-center gap-2">
          <button id="renameChatBtn" class="btn btn-sm btn-outline-secondary">Rename</button>
          <button id="pinChatBtn" class="btn btn-sm btn-outline-secondary">Pin</button>
          <button id="deleteChatBtn" class="btn btn-sm btn-outline-danger">Delete</button>
        </div>
      </div>

      <div id="messages" class="flex-grow-1 overflow-auto p-3 bg-light message-container"></div>

      <div class="border-top p-2">
        <form id="sendForm" class="container-fluid">
          {% csrf_token %}
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-10">
              <textarea id="messageInput" class="form-control" rows="1" placeholder="Type a message..."></textarea>
            </div>
            <div class="col-12 col-md-2 d-grid">
              <button type="submit" class="btn btn-primary">Send</button>
            </div>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>

<!-- Delete confirm modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete chat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">Are you sure you want to delete this chat?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const chatListEl = document.getElementById('chatList');
  const messagesEl = document.getElementById('messages');
  const sendForm = document.getElementById('sendForm');
  const messageInput = document.getElementById('messageInput');
  const modelSelect = document.getElementById('modelSelect');
  const chatTitleEl = document.getElementById('chatTitle');
  const newChatBtn = document.getElementById('newChatBtn');
  const chatSearch = document.getElementById('chatSearch');
  const renameChatBtn = document.getElementById('renameChatBtn');
  const pinChatBtn = document.getElementById('pinChatBtn');
  const deleteChatBtn = document.getElementById('deleteChatBtn');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));

  let currentChatId = window.INITIAL_CHAT_ID || '';
  let currentModel = window.DEFAULT_MODEL || modelSelect.value;
  if (currentModel) { modelSelect.value = currentModel; }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function escapeHtml(str) {
    return (str || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function renderMarkdownLite(text) {
    const safe = escapeHtml(text || '');
    const lines = safe.split(/\r?\n/);
    let html = '';
    let inList = false;
    for (const line of lines) {
      const t = line.trim();
      const isBullet = /^(?:[-*â€¢]|\d+\.)\s+/.test(t);
      if (isBullet) {
        if (!inList) { html += '<ul class="mb-2">'; inList = true; }
        html += `<li>${t.replace(/^(?:[-*â€¢]|\d+\.)\s+/, '')}</li>`;
      } else {
        if (inList) { html += '</ul>'; inList = false; }
        html += t === '' ? '<br />' : `<p class="mb-2">${t}</p>`;
      }
    }
    if (inList) html += '</ul>';
    return html;
  }

  function messageControlsHtml(msg) {
    const editHtml = msg.role === 'user' ? '<button class="btn btn-link btn-sm p-0 me-2 edit-msg">Edit</button>' : '';
    const regenHtml = msg.role === 'assistant' ? '<button class="btn btn-link btn-sm p-0 me-2 regen-msg">Regenerate</button>' : '';
    return `${editHtml}${regenHtml}<button class="btn btn-link btn-sm p-0 text-danger delete-msg">Delete</button>`;
  }

  function renderMessage(msg) {
    const isUser = msg.role === 'user';
    const wrap = document.createElement('div');
    wrap.className = `d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'} my-2`;

    const bubble = document.createElement('div');
    bubble.className = `p-3 rounded shadow-sm ${isUser ? 'bg-primary text-white' : 'bg-white border'}`;
    bubble.style.maxWidth = '80%';
    bubble.innerHTML = renderMarkdownLite(msg.content);

    const container = document.createElement('div');
    container.className = 'd-flex align-items-start gap-2';

    container.appendChild(bubble);

    const actions = document.createElement('div');
    actions.className = 'ms-2 small text-muted';
    actions.innerHTML = messageControlsHtml(msg);
    actions.querySelector('.delete-msg').addEventListener('click', () => deleteMessage(msg.id));
    if (isUser) {
      actions.querySelector('.edit-msg').addEventListener('click', () => editMessageInline(msg, bubble));
    }
    if (msg.role === 'assistant') {
      actions.querySelector('.regen-msg').addEventListener('click', () => regenerate());
    }

    container.appendChild(actions);
    wrap.appendChild(container);
    return wrap;
  }

  async function loadChats() {
    const res = await fetch('/chat/list/');
    const data = await res.json();
    chatListEl.innerHTML = '';
    const query = chatSearch.value.trim().toLowerCase();
    data.chats
      .filter(c => !query || c.title.toLowerCase().includes(query))
      .forEach(chat => chatListEl.appendChild(renderChatItem(chat)));
  }

  function renderChatItem(chat) {
    const item = document.createElement('div');
    item.className = `px-3 py-2 border-bottom ${String(chat.id) === String(currentChatId) ? 'bg-light' : ''}`;
    const row = document.createElement('div');
    row.className = 'd-flex align-items-center justify-content-between';

    const title = document.createElement('div');
    title.className = 'text-truncate';
    title.textContent = chat.title;

    const meta = document.createElement('div');
    meta.className = 'small text-muted d-flex align-items-center gap-2';
    if (chat.pinned) {
      const pin = document.createElement('span');
      pin.innerHTML = 'ðŸ“Œ';
      meta.appendChild(pin);
    }
    meta.appendChild(document.createTextNode(new Date(chat.updated_at).toLocaleString()));

    row.appendChild(title);
    row.appendChild(meta);
    item.appendChild(row);
    item.addEventListener('click', () => selectChat(chat.id));
    return item;
  }

  async function loadChat(chatId) {
    const res = await fetch(`/chat/api/chat/${chatId}/`);
    const data = await res.json();
    messagesEl.innerHTML = '';
    chatTitleEl.textContent = data.chat.title;
    modelSelect.value = data.chat.model || modelSelect.value;
    pinChatBtn.classList.toggle('btn-primary', !!data.chat.pinned);
    pinChatBtn.textContent = data.chat.pinned ? 'Pinned' : 'Pin';
    data.messages.forEach(m => messagesEl.appendChild(renderMessage(m)));
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function selectChat(chatId) {
    currentChatId = chatId;
    await loadChats();
    await loadChat(chatId);
  }

  async function ensureChatCreated(initialText) {
    if (currentChatId) return currentChatId;
    const form = new URLSearchParams();
    form.set('title', initialText || 'New Chat');
    form.set('model', modelSelect.value);
    const res = await fetch('/chat/create/', { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: form });
    const data = await res.json();
    currentChatId = data.chat_id;
    await loadChats();
    return currentChatId;
  }

  function typingIndicator() {
    const div = document.createElement('div');
    div.className = 'd-flex align-items-center gap-2 my-2';
    div.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary" role="status"></div><span class="small text-muted">Assistant is typingâ€¦</span>';
    return div;
  }

  async function sendMessage(e) {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;
    messageInput.value = '';

    await ensureChatCreated(text);

    messagesEl.appendChild(renderMessage({ id: 0, role: 'user', content: text }));
    messagesEl.scrollTop = messagesEl.scrollHeight;

    const indicator = typingIndicator();
    messagesEl.appendChild(indicator);

    const form = new URLSearchParams();
    form.set('message', text);
    if (currentChatId) form.set('chat_id', currentChatId);
    form.set('model', modelSelect.value);

    const res = await fetch('/chat/send/', { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: form });
    const data = await res.json();

    indicator.remove();
    const fullResponse = data.assistant?.content || '';
    const bubble = renderMessage({ id: 0, role: 'assistant', content: '' });
    messagesEl.appendChild(bubble);

    await typeText(bubble.querySelector('.rounded'), fullResponse);
    chatTitleEl.textContent = data.title;
  }

  async function typeText(element, fullText, speed = 10) {
    return new Promise(resolve => {
      let i = 0;
      const timer = setInterval(() => {
        if (i >= fullText.length) { clearInterval(timer); resolve(); return; }
        i++;
        element.innerHTML = renderMarkdownLite(fullText.slice(0, i));
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, speed);
    });
  }

  async function renameChat() {
    if (!currentChatId) return;
    const title = prompt('New chat title:', chatTitleEl.textContent || '');
    if (!title) return;
    const form = new URLSearchParams();
    form.set('title', title);
    await fetch(`/chat/chat/${currentChatId}/rename/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: form });
    await loadChats();
    await loadChat(currentChatId);
  }

  async function togglePin() {
    if (!currentChatId) return;
    await fetch(`/chat/chat/${currentChatId}/pin/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
    await loadChats();
    await loadChat(currentChatId);
  }

  async function confirmDeleteChat() { confirmDeleteModal.show(); }
  async function doDeleteChat() {
    if (!currentChatId) return;
    await fetch(`/chat/chat/${currentChatId}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
    confirmDeleteModal.hide();
    currentChatId = '';
    chatTitleEl.textContent = '';
    messagesEl.innerHTML = '';
    await loadChats();
  }

  async function editMessageInline(msg, bubbleEl) {
    const current = msg.content;
    const textarea = document.createElement('textarea');
    textarea.className = 'form-control';
    textarea.value = current;
    bubbleEl.replaceWith(textarea);
    textarea.focus();
    textarea.addEventListener('blur', async () => {
      const newVal = textarea.value.trim();
      if (newVal && newVal !== current) {
        const form = new URLSearchParams();
        form.set('content', newVal);
        await fetch(`/chat/message/${msg.id}/edit/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: form });
        await loadChat(currentChatId);
      } else {
        await loadChat(currentChatId);
      }
    });
  }

  async function deleteMessage(messageId) {
    await fetch(`/chat/message/${messageId}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
    await loadChat(currentChatId);
  }

  async function regenerate() {
    if (!currentChatId) return;
    const indicator = typingIndicator();
    messagesEl.appendChild(indicator);
    const res = await fetch(`/chat/chat/${currentChatId}/regenerate/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
    const data = await res.json();
    indicator.remove();
    const bubble = renderMessage({ id: 0, role: 'assistant', content: '' });
    messagesEl.appendChild(bubble);
    await typeText(bubble.querySelector('.rounded'), data.assistant?.content || '');
  }

  chatSearch.addEventListener('input', loadChats);
  sendForm.addEventListener('submit', sendMessage);
  newChatBtn.addEventListener('click', async () => { currentChatId = ''; chatTitleEl.textContent = ''; messagesEl.innerHTML = ''; messageInput.focus(); });
  renameChatBtn.addEventListener('click', renameChat);
  pinChatBtn.addEventListener('click', togglePin);
  deleteChatBtn.addEventListener('click', confirmDeleteChat);
  confirmDeleteBtn.addEventListener('click', doDeleteChat);

  loadChats().then(() => { if (currentChatId) loadChat(currentChatId); });
</script>
{% endblock %}